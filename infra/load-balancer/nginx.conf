{{range services}} {{$name := .Name}} {{$service := service .Name}}
upstream {{$name}} {
  zone upstream-{{$name}} 64k;
  {{range $service}}server {{.Address}}:{{.Port}} max_fails=3 fail_timeout=60 weight=1;
  {{else}}server 127.0.0.1:65535; # force a 502{{end}}
} {{end}}

server {
  listen 80 default_server;

  location / {
    root /usr/share/nginx/html/;
    index index.html;
  }

  location /stub_status {
    stub_status;
  }

{{range services}} {{$name := .Name}}
  location /{{$name}} {
    rewrite /{{$name}}(.*) $1  break;
    proxy_pass http://{{$name}};
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
  }
{{end}}
}
# upstream app {
#   least_conn;
#   {{range service "production.api"}}server {{.Address}}:{{.Port}} max_fails=3 fail_timeout=60 weight=1;
#   {{else}}server 127.0.0.1:65535; # force a 502{{end}}
# }

# upstream deploy_app {
#   least_conn;
#   {{range service "production.deploy"}}server {{.Address}}:{{.Port}} max_fails=3 fail_timeout=60 weight=1;
#   {{else}}server 127.0.0.1:65535; # force a 502{{end}}
# }

# upstream grafana {
#   least_conn;
#   {{range service "production.grafana"}}server {{.Address}}:{{.Port}} max_fails=3 fail_timeout=60 weight=1;
#   {{else}}server 127.0.0.1:65535; # force a 502{{end}}
# }

# upstream cadvisor {
#   least_conn;
#   {{range service "production.cadvisor"}}server {{.Address}}:{{.Port}} max_fails=3 fail_timeout=60 weight=1;
#   {{else}}server 127.0.0.1:65535; # force a 502{{end}}
# }


# error_log /dev/error_log error;


# server {
#   listen 80 default_server;

#   location /deploy {
#     proxy_pass http://deploy_app;
#     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#     proxy_set_header Host $host;
#     proxy_set_header X-Real-IP $remote_addr;
#   }

#   location /grafana {
#     proxy_pass http://grafana;
#     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#     proxy_set_header Host $host;
#     proxy_set_header X-Real-IP $remote_addr;
#   }

#   location /cadvisor {
#     proxy_pass http://cadvisor;
#     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#     proxy_set_header Host $host;
#     proxy_set_header X-Real-IP $remote_addr;
#   }
  
#   location /api {
#     rewrite /api(.*) /$1  break;
#     proxy_redirect  off;
#     proxy_pass http://app;

#     proxy_http_version 1.1;
#     proxy_set_header Upgrade $http_upgrade;
#     proxy_set_header Connection 'upgrade';
#     proxy_cache_bypass $http_upgrade;

#     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#     proxy_set_header Host $host;
#     proxy_set_header X-Real-IP $remote_addr;

#   }

# }

